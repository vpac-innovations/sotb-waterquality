<!DOCTYPE html>
<html>
  <head>
    <title>Easy example | CartoDB.js</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
    <style>
      html, body, #map {
        height: 100%;
        padding: 0;
        margin: 0;
      }
    </style>

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
  </head>
  <body>
    <div id="map"></div>

    <!-- include cartodb.js library -->
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>

    <script type="text/javascript">
    var INFOWINDOW_TEMPLATE = [
        '<div class="cartodb-popup v2">',
        '  <a href="#close" class="cartodb-popup-close-button close">x</a>',
        '  <div class="cartodb-popup-content-wrapper">',
        '    <div class="cartodb-popup-content">',
        '      <h4>sampledate</h4>',
        '      <p>{{sampledate}}</p>',
        '      <h4>site_id</h4>',
        '      <p>{{site_id}}</p>',
        '      <h4>temp</h4>',
        '      <p>{{temp}}</p>',
        '    </div>',
        '    <div id="chart_div">',
        '      <script>',
        '        draw_chart({{content.data.site_id}})',
        '      </scr' + 'ipt>',
        '    </div>',
        '  </div>',
        '  <div class="cartodb-popup-tip-container"></div>',
        '</div>'].join('');

      function draw_chart(site_id) {
          if (!site_id) {
              return;
          }
          console.log(site_id);
          var query = '' +
            'SELECT cartodb_id, '+
            //'    res.the_geom, '+
            //'    res.the_geom_webmercator, '+
            '    waterquality_data.site_id as site_id,  '+
            '    waterquality_data.temperature_thermometer as temperature, '+
            '    waterquality_data.sample_datetime as sampledate '+
            'FROM waterquality_data '+
            'LEFT JOIN ( '+
            '    SELECT site_id,the_geom,the_geom_webmercator '+
            '    FROM waterquality_sitedetails  '+
            ') AS res  '+
            'ON res.site_id = waterquality_data.site_id '+
            'WHERE res.site_id = ' + site_id + ' ' +
            'ORDER BY site_id, sampledate ';
          $.getJSON('https://lachlanhurst.cartodb.com/api/v2/sql?q=' + query, function(data) {
              console.log(data);
          });
      }

      function main() {
        cartodb.createVis('map', 'https://lachlanhurst.cartodb.com/api/v2/viz/30caf0c0-eef0-11e5-8592-0e787de82d45/viz.json', {
            shareable: true,
            title: true,
            description: true,
            tiles_loader: true
        })
        .done(function(vis, layers) {
          // layer 0 is the base layer, layer 1 is cartodb layer
          // setInteraction is disabled by default
          layers[1].setInteraction(true);
          layers[1].on('featureClick', function(e, latlng, pos, data) {
            cartodb.log.log(e, latlng, pos, data);
          });

          var infowindow = layers[1].getSubLayer(0).infowindow
          infowindow.set({
              'template':INFOWINDOW_TEMPLATE,
              sanitizeTemplate: false,
              width:      328,
              maxHeight:  400
          });

          // you can get the native map to work with it
          var map = vis.getNativeMap();
          // now, perform any operations you need
          // map.setZoom(3);
          // map.panTo([50.5, 30.5]);
        })
        .error(function(err) {
          console.log(err);
        });
      }
      window.onload = main;
    </script>
  </body>
</html>
