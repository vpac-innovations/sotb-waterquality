<!DOCTYPE html>
<html>
  <head>
    <title>Easy example | CartoDB.js</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
    <style>
      html, body, #map {
        height: 100%;
        padding: 0;
        margin: 0;
      }
    </style>

    <script src="d3/d3.js"></script>
    <link rel="stylesheet" href="nvd3/build/nv.d3.css"></link>
    <script src="nvd3/build/nv.d3.js"></script>

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
  </head>
  <body>
    <div id="map"></div>

    <!-- include cartodb.js library -->
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>

    <script type="text/javascript">
    var INFOWINDOW_TEMPLATE = [
        '<div class="cartodb-popup v2">',
        '  <a href="#close" class="cartodb-popup-close-button close">x</a>',
        '  <div class="cartodb-popup-content-wrapper">',
        '    <div class="cartodb-popup-content">',
        '      <h4>sampledate</h4>',
        '      <p>{{sampledate}}</p>',
        '      <h4>site_id</h4>',
        '      <p>{{site_id}}</p>',
        '      <h4>temp</h4>',
        '      <p>{{temp}}</p>',
        '    </div>',
        '    <div id="chart">',
        '      <svg style="height:300px; width:400px;"> </svg>',
        '      <script>',
        '        query_chart_data({{content.data.site_id}})',
        '      </scr' + 'ipt>',
        '    </div>',
        '  </div>',
        '  <div class="cartodb-popup-tip-container"></div>',
        '</div>'].join('');

      function query_chart_data(site_id) {
          if (!site_id) {
              return;
          }
          console.log(site_id);
          var query = '' +
            'SELECT cartodb_id, '+
            //'    res.the_geom, '+
            //'    res.the_geom_webmercator, '+
            '    waterquality_data.site_id as site_id,  '+
            '    waterquality_data.temperature_thermometer as temperature, '+
            '    waterquality_data.sample_datetime as sampledate '+
            'FROM waterquality_data '+
            'LEFT JOIN ( '+
            '    SELECT site_id,the_geom,the_geom_webmercator '+
            '    FROM waterquality_sitedetails  '+
            ') AS res  '+
            'ON res.site_id = waterquality_data.site_id '+
            'WHERE res.site_id = ' + site_id + ' ' +
            'ORDER BY site_id, sampledate ';
          var queryUrl = 'https://lachlanhurst.cartodb.com/api/v2/sql?q=' + query;

          d3.json(queryUrl, function(data) {

              var tickMultiFormat = d3.time.format.multi([
                          ["%-I:%M%p", function(d) { return d.getMinutes(); }], // not the beginning of the hour
                          ["%-I%p", function(d) { return d.getHours(); }], // not midnight
                          ["%b %-d", function(d) { return d.getDate() != 1; }], // not the first of the month
                          ["%b %-d", function(d) { return d.getMonth(); }], // not Jan 1st
                          ["%Y", function() { return true; }]
                      ]);

              var correctData = [
              {
                  key: "Temperature",
                  values: data.rows
              }
              ]

              nv.addGraph(function() {
                var chart = nv.models.lineChart()
                              .xScale(d3.time.scale())
                              .x(function(d) {
                                  var dateOnly = d.sampledate.substr(0,10);
                                  return d3.time.format("%Y-%m-%d").parse(dateOnly);
                              })
                              .y(function(d) {
                                  return d.temperature;
                              })
                              .color(d3.scale.category10().range())
                              .useInteractiveGuideline(true)
                              .margin({"left": 30, "right": 20, "top": 20, "bottom": 30,})
                              ;


                 //chart.forceX(parseInt(data.rows[0].sampledate.substr(0,4)), parseInt(data.rows[data.rows.length-1].sampledate.substr(0,4)));

                 chart.xAxis
                    .showMaxMin(false)
                    .tickPadding(10)
                    .tickFormat(function (d) { return tickMultiFormat(new Date(d)); })
                    ;

                chart.yAxis
                    .showMaxMin(false)
                    .tickFormat(d3.format('s'))
                    ;

                d3.select('#chart svg')
                    .datum(correctData)
                    .transition()
                    .call(chart);

                //TODO: Figure out a good way to do this automatically
                nv.utils.windowResize(chart.update);

                return chart;
              });
            });

      }

      function main() {
        cartodb.createVis('map', 'https://lachlanhurst.cartodb.com/api/v2/viz/30caf0c0-eef0-11e5-8592-0e787de82d45/viz.json', {
            shareable: true,
            title: true,
            description: true,
            tiles_loader: true
        })
        .done(function(vis, layers) {
          // layer 0 is the base layer, layer 1 is cartodb layer
          // setInteraction is disabled by default
          layers[1].setInteraction(true);
          layers[1].on('featureClick', function(e, latlng, pos, data) {
            cartodb.log.log(e, latlng, pos, data);
          });

          var infowindow = layers[1].getSubLayer(0).infowindow
          infowindow.set({
              'template':INFOWINDOW_TEMPLATE,
              sanitizeTemplate: false,
              width:      400,
              maxHeight:  400
          });

          // you can get the native map to work with it
          var map = vis.getNativeMap();
          // now, perform any operations you need
          // map.setZoom(3);
          // map.panTo([50.5, 30.5]);
        })
        .error(function(err) {
          console.log(err);
        });
      }
      window.onload = main;
    </script>
  </body>
</html>
